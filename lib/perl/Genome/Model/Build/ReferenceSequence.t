#!/usr/bin/env genome-perl

use strict;
use warnings;

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
};

use above 'Genome';
use Test::More;
use Test::Exception;
use Test::MockObject::Extends;
use Genome::Test::Factory::AnalysisProject;
use Genome::Test::Factory::Model::ImportedReferenceSequence;
use Genome::Test::Factory::Build;
Genome::Report::Email->silent();

if (Genome::Sys->arch_os ne 'x86_64') {
    plan skip_all => 'requires 64-bit machine';
}else {
    plan tests => 10;
}

use_ok("Genome::Model::Build::ReferenceSequence");

my $data_dir = File::Temp::tempdir('ImportedAnnotationTest-XXXXX', CLEANUP => 1, TMPDIR => 1);
my $pp = Genome::ProcessingProfile::ImportedReferenceSequence->create(name => 'test_ref_pp');
my $taxon = Genome::Taxon->get(name => 'human');
my $patient = Genome::Individual->create(name => "test-patient", common_name => 'testpat', taxon => $taxon);
my $sample = Genome::Sample->create(name => "test-patient", common_name => 'tumor', source => $patient);
ok($sample, 'created sample');

Genome::Test::Factory::AnalysisProject->setup_system_analysis_project;

my $sequence_uri = "http://genome.wustl.edu/foo/bar/test.fa.gz";

my $fasta_file1 = "$data_dir/data.fa";
my $fasta_fh = new IO::File(">$fasta_file1");
$fasta_fh->write(">HI\nNACTGACTGNNACTGN\n");
$fasta_fh->close();

my $command = Genome::Model::Command::Define::ImportedReferenceSequence->create(
    fasta_file => $fasta_file1,
    model_name => 'test-ref-seq-1',
    processing_profile => $pp,
    species_name => 'human',
    subject => $sample,
    version => 42,
    sequence_uri => $sequence_uri
);

my $build_name = 'test-ref-seq-1-build42';

ok($command, 'created command');
ok($command->execute(), 'executed command');

my $build_id = $command->result_build_id;
my $build = Genome::Model::Build->get($build_id);

is($build->name, $build_name, "getting build name doesn't crash");

my $path = $build->get_sequence_dictionary('sam','human','1.29');
ok(-e $path, 'get sequence dictionary returned valid path');

is(Genome::Model::Build::ReferenceSequence->get_by_name($build_name), $build,
    'get_by_name returns expected build');

# XXX Depends on database, but was used to prevent regression in refactor
ok(Genome::Model::Build::ImportedReferenceSequence->get_by_name('NCBI-human-build36'));

# TODO test to see if get_feature_list works in multiple recursive situations

subtest 'is_superset_of' => sub {
    my $mock_base_ref = get_mock_ref_build();
    my $mock_superset_ref = get_mock_ref_build();

    $mock_base_ref->mock('chromosome_array_ref', sub {return [qw(1 2 3)]});
    $mock_superset_ref->mock('chromosome_array_ref', sub {return [qw(1 2 3 4)]});
    ok($mock_superset_ref->is_superset_of($mock_base_ref), 'is_superset_of returns true when expected');
    ok(!$mock_base_ref->is_superset_of($mock_superset_ref), 'is_superset_of returns false when expected');
};

subtest 'get_feature_list' => sub {
    my $base_ref = get_mock_ref_build();
    my $middle_ref = get_mock_ref_build();
    my $leaf_ref = get_mock_ref_build();

    $middle_ref->mock('derived_from', sub {return $base_ref});
    $leaf_ref->mock('derived_from', sub {return $middle_ref});

    $base_ref->mock('chromosome_array_ref', sub {return [qw(1 2 3)]});
    $middle_ref->mock('chromosome_array_ref', sub {return [qw(1 2 3)]});
    $leaf_ref->mock('chromosome_array_ref', sub {return [qw(1 2 3)]});

    dies_ok(sub{$base_ref->get_feature_list('segmental_duplications')}, "get_feature_list dies when no feature list is set on this and this has no ancestors");
    dies_ok(sub{$middle_ref->get_feature_list('segmental_duplications')}, "get_feature_list dies when no feature list is set on this or its ancestors");

    my $feature_list_1 = Genome::FeatureList->__define__(reference => $base_ref);
    $base_ref->mock('segmental_duplications', sub {return $feature_list_1});

    is($leaf_ref->get_feature_list('segmental_duplications'), $feature_list_1, "Ref builds can get feature lists from their ancestors");

    my $feature_list_2 = Genome::FeatureList->__define__(reference => $leaf_ref);
    $leaf_ref->mock('segmental_duplications', sub {return $feature_list_2});

    is($leaf_ref->get_feature_list('segmental_duplications'), $feature_list_2, "Ref builds can get feature lists from themselves");

    $base_ref->mock('chromosome_array_ref', sub {return [qw(1 2 3 4)]});
    dies_ok(sub{$middle_ref->get_feature_list('segmental_duplications')}, "get_feature_list dies when the feature lists's reference is a superset of our reference");
};

sub get_mock_ref_build {
    my $model = Genome::Test::Factory::Model::ImportedReferenceSequence->setup_object();
    my $build = Genome::Test::Factory::Build->setup_object(model_id => $model->id);
    my $mock_build = Test::MockObject::Extends->new($build);
    return $mock_build;
}
