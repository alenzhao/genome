#!/usr/bin/env genome-perl

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
};

use strict;
use warnings;

use above 'Genome';

use Test::More tests => 3;

my $pkg = 'Genome::Model::Tools::Gatk::Base';

use_ok($pkg);

{
    package Genome::Model::Tools::Gatk::Dummy;
    class Genome::Model::Tools::Gatk::Dummy {
        is => $pkg,
        has_input => [
            more_magic => {
                is => 'Boolean',
                gatk_param_name => '-mm',
                doc => 'Whether or not to use extra magic to determine the result',
            },
            incantation => {
                is => 'Text',
                gatk_param_name => '--word',
                is_many => 1,
                doc => 'The words to use',
            },
            taps => {
                is => 'Number',
                gatk_param_name => '-n',
                is_optional => 1,
                doc => 'The number of taps of the wand. (If not provided, will be divined from the incantation.)',
            },
        ],
        doc => 'Unlike real GATK modules, this one contains no science.',
    };

    sub analysis_type { return 'Magic'; }
}

my $gatk_version = '2.4';

subtest 'all parameters specified' => sub {
    plan tests => 2;
    my $cmd = Genome::Model::Tools::Gatk::Dummy->create(
        more_magic => 1,
        incantation => ['hocus', 'pocus'],
        taps => 3,
        tmp_dir => '/tmp/testing',
        max_memory => 1,
        version => $gatk_version,
        java_interpreter => '/path/to/custom-java',
    );

    isa_ok($cmd, $pkg, 'created a dummy test command');

    my @cmdline = $cmd->gatk_command;
    is_deeply(\@cmdline,[qw(/path/to/custom-java -Xmx1g -Djava.io.tmpdir=/tmp/testing -jar), $cmd->gatk_path($gatk_version), qw(-et NO_ET -T Magic --word hocus --word pocus -mm -n 3)], 'generated the expected command line');
};

subtest 'optional parameters not specified' => sub {
    plan tests => 2;
    my $cmd = Genome::Model::Tools::Gatk::Dummy->create(
        more_magic => 0,
        tmp_dir => '/tmp/testing',
        max_memory => 1,
        version => $gatk_version,
    );

    isa_ok($cmd, $pkg, 'created a dummy test command');

    my $java_path = Genome::Model::Tools::Gatk::Base->__meta__->property(property_name => 'java_interpreter')->default_value;

    my @cmdline = $cmd->gatk_command;
    is_deeply(\@cmdline,[$java_path, qw(-Xmx1g -Djava.io.tmpdir=/tmp/testing -jar), $cmd->gatk_path($gatk_version), qw(-et NO_ET -T Magic)], 'generated the expected command line');
};

done_testing();
