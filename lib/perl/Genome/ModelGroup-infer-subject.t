#!/usr/bin/env genome-perl

BEGIN { 
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
}

use strict;
use warnings;
use above "Genome";
use Test::More;

use_ok('Genome::ModelGroup') or die;
use_ok('Genome::Model::ReferenceAlignment') or die;
ok(Genome::ProcessingProfile::ReferenceAlignment->class, 'loaded ref-align processing-profile');

my $taxon = Genome::Taxon->create(
    name => 'test taxon', 
    species_name => 'human', 
    domain => 'eukaryota'
);
ok($taxon, 'created test taxon') or die;

my $indiv_1 = Genome::Individual->create(
    name => 'Timmy',
    taxon_id => $taxon->id,
);
ok($indiv_1, 'created test indiv 1') or die;

my $indiv_2 = Genome::Individual->create(
    name => 'Bob',
    taxon_id => $taxon->id,
);
ok($indiv_2, 'created test indiv 2') or die;

my $sample_1 = Genome::Sample->create(
    name => 'test sample',
    source_id => $indiv_1->id,
);
ok($sample_1, 'created test sample 1') or die;

my $sample_2 = Genome::Sample->create(
    name => 'test sample 2',
    source_id => $indiv_2->id,
);
ok($sample_2, 'created test sample 2') or die;

my $pp = make_test_processing_profile();
ok($pp, 'made test processing profile') or die;

my $model_1 = make_test_model($pp, $sample_1);
ok($model_1, 'created test model 1 using subject ' . $sample_1->__display_name__) or die;

my $model_2 = make_test_model($pp, $sample_2);
ok($model_2, 'created test model 2 using subject ' . $sample_2->__display_name__) or die;

my $model_group = Genome::ModelGroup->create(
    name => 'test model group',
);
ok($model_group, 'created model group') or die;

$model_group->assign_models($model_1, $model_2);
my @models = $model_group->models;
ok(@models == 2, 'added both test model to model group');

my $group_subject = $model_group->infer_group_subject;
isa_ok($group_subject, 'Genome::PopulationGroup', 'model group subject is a population group, as expected');

my $indiv_hash = Genome::PopulationGroup->generate_hash_for_individuals($indiv_1, $indiv_2);
ok($indiv_hash eq $group_subject->member_hash, "population group has both samples' individuals in it");

$model_1->subject($taxon);

$group_subject = $model_group->infer_group_subject;
isa_ok($group_subject, 'Genome::Taxon', "model group subject is now a taxon after changing one model's subject to be a taxon");
ok($group_subject->id eq $taxon->id, "group subject is the test taxon");

my $taxon_2 = Genome::Taxon->create(
    name => 'some other test taxon',
    species_name => 'human',
    domain => 'eukaryota',
);

$model_1->subject($taxon_2);

$group_subject = $model_group->infer_group_subject;
isa_ok($group_subject, 'Genome::Taxon', "model group subject is now a taxon after changing one model's subject to be a taxon");
ok($group_subject->name eq 'unknown', 'group subject is the unknown taxon, as expected');

done_testing();

sub make_test_model {
    my ($pp, $subject) = @_;
    my $model = Genome::Model::DeNovoAssembly->create(
        processing_profile_id => $pp->id,
        subject_id => $subject->id,
        subject_class_name => $subject->class,
    );
    return $model;
}

sub make_test_processing_profile {
    my $pp = Genome::ProcessingProfile::DeNovoAssembly->create(
        name => 'test pp',
        assembler_name => 'newbler de-novo-assemble',
        assembler_version => '1.2.3',
        assembler_params => '',
    );
    return $pp;
}

