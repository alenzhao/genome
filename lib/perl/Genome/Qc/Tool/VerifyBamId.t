#!/usr/bin/env genome-perl

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
}

use strict;
use warnings;

use above "Genome";
use Test::More;
use Sub::Override;

my $pkg = 'Genome::Qc::Tool::VerifyBamId';
use_ok($pkg);

my $override = Sub::Override->new(
    'Genome::Qc::Tool::sample_name',
    sub { return 'H_IJ-NA12878-23830'; },
);

my $data_dir = __FILE__.".d";

my $output = File::Spec->join($data_dir, 'out');
my $temp_file = Genome::Sys->create_temp_file_path;

my $tool = $pkg->create(
    gmt_params => {
        vcf => $temp_file,
        bam => $temp_file,
        out_prefix => $output,
        max_depth => '20',
        precise => '0',
        version => '20120620',
    }
);
ok($tool->isa($pkg), 'Tool created successfully');

my @expected_cmd_line = (
    '/usr/bin/verifyBamID20120620',
    '--vcf',
    $temp_file,
    '--bam',
    $temp_file,
    '--out',
    $output,
    '--maxDepth',
    20,
    '--ignoreRG',
);
is_deeply([$tool->cmd_line], [@expected_cmd_line], 'Command line list as expected');

my %expected_metrics = (
    chipmix => '0.04989',
    freemix => '0.00000',
    number_snps => '348231',
);
is_deeply({$tool->get_metrics}, {%expected_metrics}, 'Parsed metrics as expected');

done_testing;
