#!/usr/bin/env genome-perl

BEGIN { 
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
}

use strict;
use warnings;

use above "Genome";
use Test::More;
use Genome::Utility::Test qw(compare_ok);
use Genome::File::Vcf::Differ;

my $pkg = 'Genome::Model::Tools::Vcf::FinalPassOnly';

use_ok($pkg);
my $data_dir = Genome::Utility::Test->data_dir_ok($pkg, "v1");

subtest "output vcf" => sub {
    my $out = Genome::Sys->create_temp_file_path('test.vcf.gz');
    my %params = (
        input_file  => File::Spec->join($data_dir, 'snvs.vcf.gz'),
        output_file => $out,
        sample_name => 'TEST-patient1-somval_tumor1',
    );
    my $cmd = $pkg->create(%params);
    ok($cmd->isa($pkg), "Command created ok");
    ok($cmd->execute, "Command executed ok");

    my $expected_out = File::Spec->join($data_dir, "expected.vcf.gz");
    my $differ = Genome::File::Vcf::Differ->new($out, $expected_out);
    my $diff = $differ->diff;
    is($diff, undef, "Found No differences between $out and (expected) $expected_out") ||
       diag $diff->to_string;
};

done_testing;
