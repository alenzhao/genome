#!/usr/bin/env genome-perl

BEGIN { 
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
}

use strict;
use warnings;

use above "Genome";
use Test::More;

my $pkg = 'Genome::Qc::Tool::Samtools::Flagstat';
use_ok($pkg);

my $data_dir = __FILE__.".d";

my $output_file = File::Spec->join($data_dir, 'output_file.txt');
my $temp_file = Genome::Sys->create_temp_file_path;

my $tool = $pkg->create(
    gmt_params => {
        'bam-file' => $temp_file,
        'output-file' => $output_file,
    }
);
ok($tool->isa($pkg), 'Tool created successfully');

my @expected_cmd_line =(
    'gmt',
    'sam',
    'flagstat',
    sprintf('--output-file=%s', $output_file),
    sprintf('--bam-file=%s', $temp_file),
);
is_deeply([$tool->cmd_line], [@expected_cmd_line], 'Command line list as expected');

my %expected_metrics = (
   'hq_reads_mapped_in_interchromosomal_pairs' => '1',
   'reads_mapped' => '910',
   'reads_mapped_as_singleton' => '1',
   'reads_mapped_as_singleton_percentage' => '0.11',
   'reads_mapped_in_interchromosomal_pairs' => '13',
   'reads_mapped_in_interchromosomal_pairs_percentage' => '0.0145251396648045',
   'reads_mapped_in_pair' => '909',
   'reads_mapped_in_proper_pairs' => '895',
   'reads_mapped_in_proper_pairs_percentage' => '98.24',
   'reads_mapped_percentage' => '99.89',
   'reads_marked_as_read1' => '450',
   'reads_marked_as_read2' => '461',
   'reads_marked_duplicates' => '0',
   'reads_marked_failing_qc' => '0',
   'reads_marked_passing_qc' => '911',
   'reads_paired_in_sequencing' => '911',
   'total_reads' => '911',
);
is_deeply({$tool->get_metrics}, {%expected_metrics}, 'Parsed metrics as expected');

done_testing;
