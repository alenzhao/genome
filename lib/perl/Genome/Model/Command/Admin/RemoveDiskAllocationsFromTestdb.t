#!/usr/bin/env genome-perl

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
};

use strict;
use warnings;

use above 'Genome';
use Genome::Model::Command::Admin::RemoveDiskAllocationsFromTestdb;

use Test::More tests => 2;


subtest 'default values' => sub {
    plan tests => 3;

    my $expected_dbname = 'rgekrjgekrjg';
    my $expected_host = 'foo-db-host.example.com';
    my $expected_port = '8394';
    local $ENV{XGENOME_DS_GMSCHEMA_SERVER} = qq(dbname=${expected_dbname};host=${expected_host};port=${expected_port});

    is(Genome::Model::Command::Admin::RemoveDiskAllocationsFromTestdb::_get_default_database_name(),
        $expected_dbname,
        'dbname');
    is(Genome::Model::Command::Admin::RemoveDiskAllocationsFromTestdb::_get_default_database_server(),
        $expected_host,
        'host');
    is(Genome::Model::Command::Admin::RemoveDiskAllocationsFromTestdb::_get_default_database_port(),
        $expected_port,
        'port');
};

subtest 'collect_newly_created_allocations' => sub {
    plan tests => 3;

    my $cmd = Genome::Model::Command::Admin::RemoveDiskAllocationsFromTestdb->create();
    ok($cmd, 'created Command');

    no warnings 'redefine';

    local *Genome::Model::Command::Admin::RemoveDiskAllocationsFromTestdb::_make_iterator_for_template_allocations = sub {
        make_allocation_iterator_from_list(qw(b c e f i j));
    };

    local *Genome::Model::Command::Admin::RemoveDiskAllocationsFromTestdb::_make_iterator_for_database_allocations = sub {
        make_allocation_iterator_from_list(qw(a b c e f h i j k));
    };

    my @expected = map { Genome::Disk::StrippedDownAllocation->new(id => $_, kilobytes_requested => 1) } qw(a h k);
    my @got = $cmd->collect_newly_created_allocations();
    is_deeply(\@got,
              \@expected,
              'got differences');

    local *Genome::Model::Command::Admin::RemoveDiskAllocationsFromTestdb::_make_iterator_for_template_allocations = sub {
        make_allocation_iterator_from_list(qw(b c e f i j));
    };

    local *Genome::Model::Command::Admin::RemoveDiskAllocationsFromTestdb::_make_iterator_for_database_allocations = sub {
        make_allocation_iterator_from_list(qw(b c e f i j));
    };
    @got = $cmd->collect_newly_created_allocations();
    is_deeply([],
              \@got,
              'no differences');
};

sub make_allocation_iterator_from_list {
    my @list = @_;
    return sub {
        my $alloc_id = shift @list;
        return unless defined $alloc_id;
        return Genome::Disk::StrippedDownAllocation->new(id => $alloc_id, kilobytes_requested => 1);
    };
}
