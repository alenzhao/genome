#!/usr/bin/env genome-perl

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
}

use strict;
use warnings;

use above "Genome";
use Test::More;
use Sub::Override;
use Genome::Test::Factory::InstrumentData::Solexa;
use Genome::Test::Factory::InstrumentData::AlignmentResult;
use Cwd qw(abs_path);


my $pkg = 'Genome::Qc::Tool::Picard::CollectAlignmentSummaryMetrics';
use_ok($pkg);

my $data_dir = abs_path(__FILE__.".d");

use Genome::Qc::Tool;
my $sample_name_override = Sub::Override->new(
    'Genome::Qc::Tool::sample_name',
    sub { return 'TEST-patient1-somval_tumor1'; },
);

my $instrument_data = Genome::Test::Factory::InstrumentData::Solexa->setup_object(
    flow_cell_id => '12345ABXX',
    lane => '2',
    subset_name => '2',
    run_name => 'example',
    id => 'NA12878',
);
my $alignment_result = Genome::Test::Factory::InstrumentData::AlignmentResult->setup_object(
    instrument_data => $instrument_data,
);

my $bam_file = File::Spec->join($data_dir, 'speedseq_merged.bam');
my $reference_fasta = File::Spec->join($data_dir, 'reference.fasta');
my $temp_directory = Genome::Sys->create_temp_file_path;

use Genome::Qc::Config;
my $config_override = Sub::Override->new(
    'Genome::Qc::Config::get_commands_for_alignment_result',
    sub {
        return {
            picard_collect_alignment_summary_metrics => {
                class => 'Genome::Qc::Tool::Picard::CollectAlignmentSummaryMetrics',
                params => {
                    input_file => $bam_file,
                    refseq_file => $reference_fasta,
                    use_version => 1.123,
                    metric_accumulation_level => ['SAMPLE', 'READ_GROUP'],
                    temp_directory => $temp_directory,
                }
            },
        },
    },
);

my $command = Genome::Qc::Run->create(
    config_name => 'testing-qc-run',
    alignment_result => $alignment_result,
    %{Genome::Test::Factory::SoftwareResult::User->setup_user_hash},
);
ok($command->execute, "Command executes ok");

my %tools = $command->output_result->_tools;
my ($tool) = values %tools;
ok($tool->isa($pkg), 'Tool created successfully');

my $output = $tool->qc_metrics_file;
my @expected_cmd_line = (
    'java',
    '-Xmx4096m',
    '-XX:MaxPermSize=64m',
    '-cp',
    '/usr/share/java/ant.jar:/gscmnt/sata132/techd/solexa/jwalker/lib/picard-tools-1.123/CollectAlignmentSummaryMetrics.jar',
    'picard.analysis.CollectAlignmentSummaryMetrics',
    'ASSUME_SORTED=true',
    sprintf('INPUT=%s', $bam_file),
    'IS_BISULFITE_SEQUENCED=false',
    'MAX_INSERT_SIZE=100000',
    'MAX_RECORDS_IN_RAM=500000',
    'METRIC_ACCUMULATION_LEVEL=SAMPLE',
    'METRIC_ACCUMULATION_LEVEL=READ_GROUP',
    sprintf('OUTPUT=%s', $output),
    sprintf('REFERENCE_SEQUENCE=%s', $reference_fasta),
    sprintf('TMP_DIR=%s', $temp_directory),
    'VALIDATION_STRINGENCY=SILENT',
);
is_deeply([$tool->cmd_line], [@expected_cmd_line], 'Command line list as expected');

my %expected_metrics = (
    'FIRST_OF_PAIR	BAD_CYCLES' => '0',
    'FIRST_OF_PAIR	CATEGORY' => 'FIRST_OF_PAIR',
    'FIRST_OF_PAIR	LIBRARY' => '',
    'FIRST_OF_PAIR	MEAN_READ_LENGTH' => '100',
    'FIRST_OF_PAIR	PCT_ADAPTER' => '0',
    'FIRST_OF_PAIR	PCT_CHIMERAS' => '0.125',
    'FIRST_OF_PAIR	PCT_PF_READS' => '1',
    'FIRST_OF_PAIR	PCT_PF_READS_ALIGNED' => '0.888889',
    'FIRST_OF_PAIR	PCT_READS_ALIGNED_IN_PAIRS' => '1',
    'FIRST_OF_PAIR	PF_ALIGNED_BASES' => '1521',
    'FIRST_OF_PAIR	PF_HQ_ALIGNED_BASES' => '779',
    'FIRST_OF_PAIR	PF_HQ_ALIGNED_Q20_BASES' => '762',
    'FIRST_OF_PAIR	PF_HQ_ALIGNED_READS' => '8',
    'FIRST_OF_PAIR	PF_HQ_ERROR_RATE' => '0.030809',
    'FIRST_OF_PAIR	PF_HQ_MEDIAN_MISMATCHES' => '0',
    'FIRST_OF_PAIR	PF_INDEL_RATE' => '0.001315',
    'FIRST_OF_PAIR	PF_MISMATCH_RATE' => '0.031558',
    'FIRST_OF_PAIR	PF_NOISE_READS' => '0',
    'FIRST_OF_PAIR	PF_READS' => '18',
    'FIRST_OF_PAIR	PF_READS_ALIGNED' => '16',
    'FIRST_OF_PAIR	READS_ALIGNED_IN_PAIRS' => '16',
    'FIRST_OF_PAIR	READ_GROUP' => '',
    'FIRST_OF_PAIR	SAMPLE' => '',
    'FIRST_OF_PAIR	STRAND_BALANCE' => '0.5625',
    'FIRST_OF_PAIR	TOTAL_READS' => '18',
    'PAIR	BAD_CYCLES' => '0',
    'PAIR	CATEGORY' => 'PAIR',
    'PAIR	LIBRARY' => '',
    'PAIR	MEAN_READ_LENGTH' => '100',
    'PAIR	PCT_ADAPTER' => '0',
    'PAIR	PCT_CHIMERAS' => '0.125',
    'PAIR	PCT_PF_READS' => '1',
    'PAIR	PCT_PF_READS_ALIGNED' => '0.944444',
    'PAIR	PCT_READS_ALIGNED_IN_PAIRS' => '0.941176',
    'PAIR	PF_ALIGNED_BASES' => '3205',
    'PAIR	PF_HQ_ALIGNED_BASES' => '1254',
    'PAIR	PF_HQ_ALIGNED_Q20_BASES' => '1228',
    'PAIR	PF_HQ_ALIGNED_READS' => '13',
    'PAIR	PF_HQ_ERROR_RATE' => '0.030303',
    'PAIR	PF_HQ_MEDIAN_MISMATCHES' => '0',
    'PAIR	PF_INDEL_RATE' => '0.000936',
    'PAIR	PF_MISMATCH_RATE' => '0.027769',
    'PAIR	PF_NOISE_READS' => '0',
    'PAIR	PF_READS' => '36',
    'PAIR	PF_READS_ALIGNED' => '34',
    'PAIR	READS_ALIGNED_IN_PAIRS' => '32',
    'PAIR	READ_GROUP' => '',
    'PAIR	SAMPLE' => '',
    'PAIR	STRAND_BALANCE' => '0.470588',
    'PAIR	TOTAL_READS' => '36',
    'SECOND_OF_PAIR	BAD_CYCLES' => '0',
    'SECOND_OF_PAIR	CATEGORY' => 'SECOND_OF_PAIR',
    'SECOND_OF_PAIR	LIBRARY' => '',
    'SECOND_OF_PAIR	MEAN_READ_LENGTH' => '100',
    'SECOND_OF_PAIR	PCT_ADAPTER' => '0',
    'SECOND_OF_PAIR	PCT_CHIMERAS' => '0.125',
    'SECOND_OF_PAIR	PCT_PF_READS' => '1',
    'SECOND_OF_PAIR	PCT_PF_READS_ALIGNED' => '1',
    'SECOND_OF_PAIR	PCT_READS_ALIGNED_IN_PAIRS' => '0.888889',
    'SECOND_OF_PAIR	PF_ALIGNED_BASES' => '1684',
    'SECOND_OF_PAIR	PF_HQ_ALIGNED_BASES' => '475',
    'SECOND_OF_PAIR	PF_HQ_ALIGNED_Q20_BASES' => '466',
    'SECOND_OF_PAIR	PF_HQ_ALIGNED_READS' => '5',
    'SECOND_OF_PAIR	PF_HQ_ERROR_RATE' => '0.029474',
    'SECOND_OF_PAIR	PF_HQ_MEDIAN_MISMATCHES' => '0',
    'SECOND_OF_PAIR	PF_INDEL_RATE' => '0.000594',
    'SECOND_OF_PAIR	PF_MISMATCH_RATE' => '0.024347',
    'SECOND_OF_PAIR	PF_NOISE_READS' => '0',
    'SECOND_OF_PAIR	PF_READS' => '18',
    'SECOND_OF_PAIR	PF_READS_ALIGNED' => '18',
    'SECOND_OF_PAIR	READS_ALIGNED_IN_PAIRS' => '16',
    'SECOND_OF_PAIR	READ_GROUP' => '',
    'SECOND_OF_PAIR	SAMPLE' => '',
    'SECOND_OF_PAIR	STRAND_BALANCE' => '0.388889',
    'SECOND_OF_PAIR	TOTAL_READS' => '18',
    'TEST-patient1-somval_tumor1	2883581792.	FIRST_OF_PAIR	BAD_CYCLES' => '0',
    'TEST-patient1-somval_tumor1	2883581792.	FIRST_OF_PAIR	CATEGORY' => 'FIRST_OF_PAIR',
    'TEST-patient1-somval_tumor1	2883581792.	FIRST_OF_PAIR	LIBRARY' => 'TEST-patient1-somval_tumor1-extlibs',
    'TEST-patient1-somval_tumor1	2883581792.	FIRST_OF_PAIR	MEAN_READ_LENGTH' => '100',
    'TEST-patient1-somval_tumor1	2883581792.	FIRST_OF_PAIR	PCT_ADAPTER' => '0',
    'TEST-patient1-somval_tumor1	2883581792.	FIRST_OF_PAIR	PCT_CHIMERAS' => '0.125',
    'TEST-patient1-somval_tumor1	2883581792.	FIRST_OF_PAIR	PCT_PF_READS' => '1',
    'TEST-patient1-somval_tumor1	2883581792.	FIRST_OF_PAIR	PCT_PF_READS_ALIGNED' => '0.888889',
    'TEST-patient1-somval_tumor1	2883581792.	FIRST_OF_PAIR	PCT_READS_ALIGNED_IN_PAIRS' => '1',
    'TEST-patient1-somval_tumor1	2883581792.	FIRST_OF_PAIR	PF_ALIGNED_BASES' => '1521',
    'TEST-patient1-somval_tumor1	2883581792.	FIRST_OF_PAIR	PF_HQ_ALIGNED_BASES' => '779',
    'TEST-patient1-somval_tumor1	2883581792.	FIRST_OF_PAIR	PF_HQ_ALIGNED_Q20_BASES' => '762',
    'TEST-patient1-somval_tumor1	2883581792.	FIRST_OF_PAIR	PF_HQ_ALIGNED_READS' => '8',
    'TEST-patient1-somval_tumor1	2883581792.	FIRST_OF_PAIR	PF_HQ_ERROR_RATE' => '0.030809',
    'TEST-patient1-somval_tumor1	2883581792.	FIRST_OF_PAIR	PF_HQ_MEDIAN_MISMATCHES' => '0',
    'TEST-patient1-somval_tumor1	2883581792.	FIRST_OF_PAIR	PF_INDEL_RATE' => '0.001315',
    'TEST-patient1-somval_tumor1	2883581792.	FIRST_OF_PAIR	PF_MISMATCH_RATE' => '0.031558',
    'TEST-patient1-somval_tumor1	2883581792.	FIRST_OF_PAIR	PF_NOISE_READS' => '0',
    'TEST-patient1-somval_tumor1	2883581792.	FIRST_OF_PAIR	PF_READS' => '18',
    'TEST-patient1-somval_tumor1	2883581792.	FIRST_OF_PAIR	PF_READS_ALIGNED' => '16',
    'TEST-patient1-somval_tumor1	2883581792.	FIRST_OF_PAIR	READS_ALIGNED_IN_PAIRS' => '16',
    'TEST-patient1-somval_tumor1	2883581792.	FIRST_OF_PAIR	READ_GROUP' => '2883581792.',
    'TEST-patient1-somval_tumor1	2883581792.	FIRST_OF_PAIR	SAMPLE' => 'TEST-patient1-somval_tumor1',
    'TEST-patient1-somval_tumor1	2883581792.	FIRST_OF_PAIR	STRAND_BALANCE' => '0.5625',
    'TEST-patient1-somval_tumor1	2883581792.	FIRST_OF_PAIR	TOTAL_READS' => '18',
    'TEST-patient1-somval_tumor1	2883581792.	PAIR	BAD_CYCLES' => '0',
    'TEST-patient1-somval_tumor1	2883581792.	PAIR	CATEGORY' => 'PAIR',
    'TEST-patient1-somval_tumor1	2883581792.	PAIR	LIBRARY' => 'TEST-patient1-somval_tumor1-extlibs',
    'TEST-patient1-somval_tumor1	2883581792.	PAIR	MEAN_READ_LENGTH' => '100',
    'TEST-patient1-somval_tumor1	2883581792.	PAIR	PCT_ADAPTER' => '0',
    'TEST-patient1-somval_tumor1	2883581792.	PAIR	PCT_CHIMERAS' => '0.125',
    'TEST-patient1-somval_tumor1	2883581792.	PAIR	PCT_PF_READS' => '1',
    'TEST-patient1-somval_tumor1	2883581792.	PAIR	PCT_PF_READS_ALIGNED' => '0.944444',
    'TEST-patient1-somval_tumor1	2883581792.	PAIR	PCT_READS_ALIGNED_IN_PAIRS' => '0.941176',
    'TEST-patient1-somval_tumor1	2883581792.	PAIR	PF_ALIGNED_BASES' => '3205',
    'TEST-patient1-somval_tumor1	2883581792.	PAIR	PF_HQ_ALIGNED_BASES' => '1254',
    'TEST-patient1-somval_tumor1	2883581792.	PAIR	PF_HQ_ALIGNED_Q20_BASES' => '1228',
    'TEST-patient1-somval_tumor1	2883581792.	PAIR	PF_HQ_ALIGNED_READS' => '13',
    'TEST-patient1-somval_tumor1	2883581792.	PAIR	PF_HQ_ERROR_RATE' => '0.030303',
    'TEST-patient1-somval_tumor1	2883581792.	PAIR	PF_HQ_MEDIAN_MISMATCHES' => '0',
    'TEST-patient1-somval_tumor1	2883581792.	PAIR	PF_INDEL_RATE' => '0.000936',
    'TEST-patient1-somval_tumor1	2883581792.	PAIR	PF_MISMATCH_RATE' => '0.027769',
    'TEST-patient1-somval_tumor1	2883581792.	PAIR	PF_NOISE_READS' => '0',
    'TEST-patient1-somval_tumor1	2883581792.	PAIR	PF_READS' => '36',
    'TEST-patient1-somval_tumor1	2883581792.	PAIR	PF_READS_ALIGNED' => '34',
    'TEST-patient1-somval_tumor1	2883581792.	PAIR	READS_ALIGNED_IN_PAIRS' => '32',
    'TEST-patient1-somval_tumor1	2883581792.	PAIR	READ_GROUP' => '2883581792.',
    'TEST-patient1-somval_tumor1	2883581792.	PAIR	SAMPLE' => 'TEST-patient1-somval_tumor1',
    'TEST-patient1-somval_tumor1	2883581792.	PAIR	STRAND_BALANCE' => '0.470588',
    'TEST-patient1-somval_tumor1	2883581792.	PAIR	TOTAL_READS' => '36',
    'TEST-patient1-somval_tumor1	2883581792.	SECOND_OF_PAIR	BAD_CYCLES' => '0',
    'TEST-patient1-somval_tumor1	2883581792.	SECOND_OF_PAIR	CATEGORY' => 'SECOND_OF_PAIR',
    'TEST-patient1-somval_tumor1	2883581792.	SECOND_OF_PAIR	LIBRARY' => 'TEST-patient1-somval_tumor1-extlibs',
    'TEST-patient1-somval_tumor1	2883581792.	SECOND_OF_PAIR	MEAN_READ_LENGTH' => '100',
    'TEST-patient1-somval_tumor1	2883581792.	SECOND_OF_PAIR	PCT_ADAPTER' => '0',
    'TEST-patient1-somval_tumor1	2883581792.	SECOND_OF_PAIR	PCT_CHIMERAS' => '0.125',
    'TEST-patient1-somval_tumor1	2883581792.	SECOND_OF_PAIR	PCT_PF_READS' => '1',
    'TEST-patient1-somval_tumor1	2883581792.	SECOND_OF_PAIR	PCT_PF_READS_ALIGNED' => '1',
    'TEST-patient1-somval_tumor1	2883581792.	SECOND_OF_PAIR	PCT_READS_ALIGNED_IN_PAIRS' => '0.888889',
    'TEST-patient1-somval_tumor1	2883581792.	SECOND_OF_PAIR	PF_ALIGNED_BASES' => '1684',
    'TEST-patient1-somval_tumor1	2883581792.	SECOND_OF_PAIR	PF_HQ_ALIGNED_BASES' => '475',
    'TEST-patient1-somval_tumor1	2883581792.	SECOND_OF_PAIR	PF_HQ_ALIGNED_Q20_BASES' => '466',
    'TEST-patient1-somval_tumor1	2883581792.	SECOND_OF_PAIR	PF_HQ_ALIGNED_READS' => '5',
    'TEST-patient1-somval_tumor1	2883581792.	SECOND_OF_PAIR	PF_HQ_ERROR_RATE' => '0.029474',
    'TEST-patient1-somval_tumor1	2883581792.	SECOND_OF_PAIR	PF_HQ_MEDIAN_MISMATCHES' => '0',
    'TEST-patient1-somval_tumor1	2883581792.	SECOND_OF_PAIR	PF_INDEL_RATE' => '0.000594',
    'TEST-patient1-somval_tumor1	2883581792.	SECOND_OF_PAIR	PF_MISMATCH_RATE' => '0.024347',
    'TEST-patient1-somval_tumor1	2883581792.	SECOND_OF_PAIR	PF_NOISE_READS' => '0',
    'TEST-patient1-somval_tumor1	2883581792.	SECOND_OF_PAIR	PF_READS' => '18',
    'TEST-patient1-somval_tumor1	2883581792.	SECOND_OF_PAIR	PF_READS_ALIGNED' => '18',
    'TEST-patient1-somval_tumor1	2883581792.	SECOND_OF_PAIR	READS_ALIGNED_IN_PAIRS' => '16',
    'TEST-patient1-somval_tumor1	2883581792.	SECOND_OF_PAIR	READ_GROUP' => '2883581792.',
    'TEST-patient1-somval_tumor1	2883581792.	SECOND_OF_PAIR	SAMPLE' => 'TEST-patient1-somval_tumor1',
    'TEST-patient1-somval_tumor1	2883581792.	SECOND_OF_PAIR	STRAND_BALANCE' => '0.388889',
    'TEST-patient1-somval_tumor1	2883581792.	SECOND_OF_PAIR	TOTAL_READS' => '18',
    'TEST-patient1-somval_tumor1	FIRST_OF_PAIR	BAD_CYCLES' => '0',
    'TEST-patient1-somval_tumor1	FIRST_OF_PAIR	CATEGORY' => 'FIRST_OF_PAIR',
    'TEST-patient1-somval_tumor1	FIRST_OF_PAIR	LIBRARY' => '',
    'TEST-patient1-somval_tumor1	FIRST_OF_PAIR	MEAN_READ_LENGTH' => '100',
    'TEST-patient1-somval_tumor1	FIRST_OF_PAIR	PCT_ADAPTER' => '0',
    'TEST-patient1-somval_tumor1	FIRST_OF_PAIR	PCT_CHIMERAS' => '0.125',
    'TEST-patient1-somval_tumor1	FIRST_OF_PAIR	PCT_PF_READS' => '1',
    'TEST-patient1-somval_tumor1	FIRST_OF_PAIR	PCT_PF_READS_ALIGNED' => '0.888889',
    'TEST-patient1-somval_tumor1	FIRST_OF_PAIR	PCT_READS_ALIGNED_IN_PAIRS' => '1',
    'TEST-patient1-somval_tumor1	FIRST_OF_PAIR	PF_ALIGNED_BASES' => '1521',
    'TEST-patient1-somval_tumor1	FIRST_OF_PAIR	PF_HQ_ALIGNED_BASES' => '779',
    'TEST-patient1-somval_tumor1	FIRST_OF_PAIR	PF_HQ_ALIGNED_Q20_BASES' => '762',
    'TEST-patient1-somval_tumor1	FIRST_OF_PAIR	PF_HQ_ALIGNED_READS' => '8',
    'TEST-patient1-somval_tumor1	FIRST_OF_PAIR	PF_HQ_ERROR_RATE' => '0.030809',
    'TEST-patient1-somval_tumor1	FIRST_OF_PAIR	PF_HQ_MEDIAN_MISMATCHES' => '0',
    'TEST-patient1-somval_tumor1	FIRST_OF_PAIR	PF_INDEL_RATE' => '0.001315',
    'TEST-patient1-somval_tumor1	FIRST_OF_PAIR	PF_MISMATCH_RATE' => '0.031558',
    'TEST-patient1-somval_tumor1	FIRST_OF_PAIR	PF_NOISE_READS' => '0',
    'TEST-patient1-somval_tumor1	FIRST_OF_PAIR	PF_READS' => '18',
    'TEST-patient1-somval_tumor1	FIRST_OF_PAIR	PF_READS_ALIGNED' => '16',
    'TEST-patient1-somval_tumor1	FIRST_OF_PAIR	READS_ALIGNED_IN_PAIRS' => '16',
    'TEST-patient1-somval_tumor1	FIRST_OF_PAIR	READ_GROUP' => '',
    'TEST-patient1-somval_tumor1	FIRST_OF_PAIR	SAMPLE' => 'TEST-patient1-somval_tumor1',
    'TEST-patient1-somval_tumor1	FIRST_OF_PAIR	STRAND_BALANCE' => '0.5625',
    'TEST-patient1-somval_tumor1	FIRST_OF_PAIR	TOTAL_READS' => '18',
    'TEST-patient1-somval_tumor1	PAIR	BAD_CYCLES' => '0',
    'TEST-patient1-somval_tumor1	PAIR	CATEGORY' => 'PAIR',
    'TEST-patient1-somval_tumor1	PAIR	LIBRARY' => '',
    'TEST-patient1-somval_tumor1	PAIR	MEAN_READ_LENGTH' => '100',
    'TEST-patient1-somval_tumor1	PAIR	PCT_ADAPTER' => '0',
    'TEST-patient1-somval_tumor1	PAIR	PCT_CHIMERAS' => '0.125',
    'TEST-patient1-somval_tumor1	PAIR	PCT_PF_READS' => '1',
    'TEST-patient1-somval_tumor1	PAIR	PCT_PF_READS_ALIGNED' => '0.944444',
    'TEST-patient1-somval_tumor1	PAIR	PCT_READS_ALIGNED_IN_PAIRS' => '0.941176',
    'TEST-patient1-somval_tumor1	PAIR	PF_ALIGNED_BASES' => '3205',
    'TEST-patient1-somval_tumor1	PAIR	PF_HQ_ALIGNED_BASES' => '1254',
    'TEST-patient1-somval_tumor1	PAIR	PF_HQ_ALIGNED_Q20_BASES' => '1228',
    'TEST-patient1-somval_tumor1	PAIR	PF_HQ_ALIGNED_READS' => '13',
    'TEST-patient1-somval_tumor1	PAIR	PF_HQ_ERROR_RATE' => '0.030303',
    'TEST-patient1-somval_tumor1	PAIR	PF_HQ_MEDIAN_MISMATCHES' => '0',
    'TEST-patient1-somval_tumor1	PAIR	PF_INDEL_RATE' => '0.000936',
    'TEST-patient1-somval_tumor1	PAIR	PF_MISMATCH_RATE' => '0.027769',
    'TEST-patient1-somval_tumor1	PAIR	PF_NOISE_READS' => '0',
    'TEST-patient1-somval_tumor1	PAIR	PF_READS' => '36',
    'TEST-patient1-somval_tumor1	PAIR	PF_READS_ALIGNED' => '34',
    'TEST-patient1-somval_tumor1	PAIR	READS_ALIGNED_IN_PAIRS' => '32',
    'TEST-patient1-somval_tumor1	PAIR	READ_GROUP' => '',
    'TEST-patient1-somval_tumor1	PAIR	SAMPLE' => 'TEST-patient1-somval_tumor1',
    'TEST-patient1-somval_tumor1	PAIR	STRAND_BALANCE' => '0.470588',
    'TEST-patient1-somval_tumor1	PAIR	TOTAL_READS' => '36',
    'TEST-patient1-somval_tumor1	SECOND_OF_PAIR	BAD_CYCLES' => '0',
    'TEST-patient1-somval_tumor1	SECOND_OF_PAIR	CATEGORY' => 'SECOND_OF_PAIR',
    'TEST-patient1-somval_tumor1	SECOND_OF_PAIR	LIBRARY' => '',
    'TEST-patient1-somval_tumor1	SECOND_OF_PAIR	MEAN_READ_LENGTH' => '100',
    'TEST-patient1-somval_tumor1	SECOND_OF_PAIR	PCT_ADAPTER' => '0',
    'TEST-patient1-somval_tumor1	SECOND_OF_PAIR	PCT_CHIMERAS' => '0.125',
    'TEST-patient1-somval_tumor1	SECOND_OF_PAIR	PCT_PF_READS' => '1',
    'TEST-patient1-somval_tumor1	SECOND_OF_PAIR	PCT_PF_READS_ALIGNED' => '1',
    'TEST-patient1-somval_tumor1	SECOND_OF_PAIR	PCT_READS_ALIGNED_IN_PAIRS' => '0.888889',
    'TEST-patient1-somval_tumor1	SECOND_OF_PAIR	PF_ALIGNED_BASES' => '1684',
    'TEST-patient1-somval_tumor1	SECOND_OF_PAIR	PF_HQ_ALIGNED_BASES' => '475',
    'TEST-patient1-somval_tumor1	SECOND_OF_PAIR	PF_HQ_ALIGNED_Q20_BASES' => '466',
    'TEST-patient1-somval_tumor1	SECOND_OF_PAIR	PF_HQ_ALIGNED_READS' => '5',
    'TEST-patient1-somval_tumor1	SECOND_OF_PAIR	PF_HQ_ERROR_RATE' => '0.029474',
    'TEST-patient1-somval_tumor1	SECOND_OF_PAIR	PF_HQ_MEDIAN_MISMATCHES' => '0',
    'TEST-patient1-somval_tumor1	SECOND_OF_PAIR	PF_INDEL_RATE' => '0.000594',
    'TEST-patient1-somval_tumor1	SECOND_OF_PAIR	PF_MISMATCH_RATE' => '0.024347',
    'TEST-patient1-somval_tumor1	SECOND_OF_PAIR	PF_NOISE_READS' => '0',
    'TEST-patient1-somval_tumor1	SECOND_OF_PAIR	PF_READS' => '18',
    'TEST-patient1-somval_tumor1	SECOND_OF_PAIR	PF_READS_ALIGNED' => '18',
    'TEST-patient1-somval_tumor1	SECOND_OF_PAIR	READS_ALIGNED_IN_PAIRS' => '16',
    'TEST-patient1-somval_tumor1	SECOND_OF_PAIR	READ_GROUP' => '',
    'TEST-patient1-somval_tumor1	SECOND_OF_PAIR	SAMPLE' => 'TEST-patient1-somval_tumor1',
    'TEST-patient1-somval_tumor1	SECOND_OF_PAIR	STRAND_BALANCE' => '0.388889',
    'TEST-patient1-somval_tumor1	SECOND_OF_PAIR	TOTAL_READS' => '18',
);
is_deeply({$command->output_result->get_metrics}, {%expected_metrics}, 'Parsed metrics as expected');

$config_override->restore;

done_testing;
