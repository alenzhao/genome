#!/usr/bin/env genome-perl

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
}

use strict;
use warnings;

use above 'Genome';
use Test::More;

use File::Basename qw(dirname);

use lib File::Spec->join(dirname(__FILE__), 'Allocation', 't-lib');
use GenomeDiskAllocationCommon qw(create_test_volumes);

use File::stat qw(stat);
use Genome::Utility::File::Mode qw(mode);

use_ok('Genome::Disk::Allocation') or die;
use_ok('Genome::Disk::Volume') or die;


my @volumes = create_test_volumes(1);


sub create_allocation_with_stuff {
    my $id = shift;
    my $a = Genome::Disk::Allocation->create(
        disk_group_name => $volumes[0]->disk_group_names,
        allocation_path => $id,
        owner_class_name => 'UR::Value',
        owner_id => "id-$id",
        kilobytes_requested => 1,
    );

    populate_allocation($a);

    return $a;
}

my @_DIRECTORIES = qw(
    foo
    foo/bar
);
my @_FILES = qw(
    baz.txt
    foo/buz.txt
    foo/bar/fiz.yml
);
sub populate_allocation {
    my $a = shift;
    for my $dir (@_DIRECTORIES) {
        mkdir File::Spec->join($a->absolute_path, $dir);
    }
    for my $file (@_FILES) {
        touch(File::Spec->join($a->absolute_path, $file));
    }
}

sub touch {
    for my $filename (@_) {
        open F, '>', $filename;
        close F;
    }
}

subtest 'set_permissions_read_only' => sub {
    plan tests => 2;

    my $a = create_allocation_with_stuff('all-perm-test');

    subtest 'allocation has writable content before set_permissions_read_only' => sub {
        plan tests => scalar(@_DIRECTORIES) + scalar(@_FILES) + 1;
        for my $item (@_FILES, @_DIRECTORIES, '.') {
            my $full_path = File::Spec->join($a->absolute_path, $item);
            my $mode = mode($full_path);
            ok(($mode->is_user_writable || $mode->is_group_writable || $mode->is_other_writable), "$item is read only");
        }
    };

    $a->set_permissions_read_only;

    subtest 'allocation does not have writable content after set_permissions_read_only' => sub {
        plan tests => scalar(@_DIRECTORIES) + scalar(@_FILES) + 1;
        for my $item (@_FILES, @_DIRECTORIES, '.') {
            my $full_path = File::Spec->join($a->absolute_path, $item);
            my $mode = mode($full_path);
            ok(!($mode->is_user_writable || $mode->is_group_writable || $mode->is_other_writable), "$item is read only");
        }
    };
};


done_testing;
